Migrating www-apps/gitlab from Ruby30 to Ruby31
===============================================

You have two options:
A) Shut down the GitLab Server during migration.
   This is simpler and faster than option B) with the drawback
   of a considerable downtime.
B) Do the migration with minimal downtime of the GitLab Server
   (as usual just the time required for restarts) with the
   drawback that you have to emerge www-apps/gitlab two times
   and that it is quite complicated.

Instructions for option A
-------------------------
Stop the GitLab Server:
  systemctl stop gitlab.target

Edit /etc/portage/make.conf to
  RUBY_TARGETS="ruby31"

Remove from /etc/portage/package.use/gitlab the line
  virtual/rubygems ruby_targets_ruby30

Remove from /etc/portage/package.mask/gitlab the line
  >=dev-libs/openssl-3

Remove from /etc/portage/package.unmask/gitlab the lines
  =dev-lang/ruby-3.0.6-r3
  =dev-libs/openssl-1.1.1u
(the file should be empty then, so remove it completely).

Remove from /etc/portage/profile/package.use.mask the lines
  >=dev-ruby/bundler-2:2 -ruby_targets_ruby30
  =dev-ruby/rubygems-3.4* -ruby_targets_ruby30
  =virtual/rubygems-17 -ruby_targets_ruby30
(the file should be empty then, so remove it completely).

Add to /etc/portage/package.accept_keywords/gitlab the line
  =virtual/rubygems-18 ~amd64

Do an update world but exclude gitlab and gitlab-shell yet:
  emerge -DuN world --exclude "gitlab gitlab-shell"
This will install dev-lang/ruby-3.1.x in a new slot and upgrade
openssl to version 3.0. Also the dev-ruby/* packages wil be rebuild
for the new RUBY_TARGET ruby31 but without RUBY_TARGET ruby30.
After the upgrade of openssl you should reboot. As it won't work
anyhow you should disable GitLab beforehand:
  systemctl disable gitlab.target
  shutdown -r now

Now switch to Ruby31 by
  eselect ruby set ruby31
and emerge the new gitlab packages by
  emerge -DuN world
This will install the new versions dev-vcs/gitlab-shell-14.28.0-r1
and www-apps/gitlab-16.4.1 (for gitlab-shell it's not a real update;
I just removed the ruby dependency from the ebuild that is needless
long-since).

When this is done, reenable and restart GitLab
  systemctl enable gitlab.target
  systemctl start gitlab.target

Now do a cleanup:
  emerge -c
This will uninstall dev-lang/ruby-3.0.x and maybe some other now
unneeded dependencies.


Instructions for option B
-------------------------
B.0) Prerequisites
You'll need a local repo for some temporary ebuilds. I used this one:
  cat /etc/portage/repos.conf/host.conf 
  [x-host]
  location = /usr/local/portage/host
  masters = gentoo
  auto-sync = no
So create the /etc/portage/repos.conf/host.conf definition and copy
the x-host directory:
  cp <path of gitlab overlay folder>/ruby30-31_migration/x-host \
  /usr/local/portage/host
Or, if you already have such a local repo, do
  cp <path of gitlab overlay folder>/ruby30-31_migration/x-host/* \
  <your local repo path>/

B.1) Install Ruby31 besides Ruby30
Edit /etc/portage/make.conf to
  RUBY_TARGETS="ruby30 ruby31"

Add to /etc/portage/package.use/gitlab the lines
  virtual/ruby-ssl ruby_targets_ruby30
  =virtual/ruby-ssl-12 -ruby_targets_ruby30
  dev-ruby/* -ruby_targets_ruby30

Temporarily replace two eclasses with their old 'ruby30' versions:
  cd /usr/portage/eclass/
  mv ruby-ng.eclass ruby-utils.eclass /root/
  cp <path of gitlab overlay folder>/ruby30-31_migration/eclass/* .

Do an update world but exclude gitlab and gitlab-shell yet:
  emerge -DuN world --exclude "gitlab gitlab-shell"
This will install dev-lang/ruby-3.1.x in a new slot and add the
ruby31 RUBY_TARGET to the dev-ruby/* packages.

B.2) Build GitLab with Ruby31
Now switch to Ruby31 by
  eselect ruby set ruby31
and emerge the new gitlab packages by
  emerge -DuN world
This will install the new versions dev-vcs/gitlab-shell-14.28.0-r1
and www-apps/gitlab-16.4.1 (for gitlab-shell it's not a real update;
I just removed the ruby dependency from the ebuild that is needless
long-since).

When this is done, restart GitLab
  systemctl daemon-reload
  systemctl restart gitlab.target

B.3) Remove Ruby30
Edit /etc/portage/make.conf to
  RUBY_TARGETS="ruby31"

Remove from /etc/portage/package.use/gitlab the lines
  virtual/rubygems ruby_targets_ruby30
  virtual/ruby-ssl ruby_targets_ruby30

Remove from /etc/portage/package.mask/gitlab the line
  >=dev-libs/openssl-3

Remove from /etc/portage/profile/package.use.mask the lines
  >=dev-ruby/bundler-2:2 -ruby_targets_ruby30
  =dev-ruby/rubygems-3.4* -ruby_targets_ruby30
  =virtual/rubygems-17 -ruby_targets_ruby30
  =virtual/ruby-ssl-12 -ruby_targets_ruby30
  dev-ruby/* -ruby_targets_ruby30
(the file should be empty then, so remove it completely).

Rebuild the system without Ruby30 by
  emerge -DuN world
This will upgrade openssl to version 3.0. Also the dev-ruby/*
packages wil be rebuild for the new RUBY_TARGET ruby31 but without
RUBY_TARGET ruby30. After the upgrade of openssl you should reboot:
  shutdown -r now

The above "emerge" will give you an "existing preserved libs" warning
for the libs from openssl-1.1 that are still used by some binaries
of www-apps/gitlab. Do
  emerge @preserved-rebuild
which should rebuild the www-apps/gitlab package.

B4) Cleanup:
  emerge -c
This will uninstall dev-lang/ruby-3.0.x and maybe some other now
unneeded dependencies.

Move back the original eclasses
  cd /root
  mv ruby-ng.eclass ruby-utils.eclass /usr/portage/eclass/

Remove the package folders added to <your local repo path>/ or the
whole /usr/local/portage/host with it's repos.conf file respectively.

Remove from /etc/portage/package.unmask/gitlab the lines
  =dev-lang/ruby-3.0.6-r3
  =dev-libs/openssl-1.1.1u
(the file should be empty then, so remove it completely).

Check if
  emerge -pDuN world
wants to update/rebuild something. If so di
  emerge -DuN world
